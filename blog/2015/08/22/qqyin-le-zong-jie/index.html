
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>QQ音乐总结 - etund喔喔喔</title>
	<meta name="author" content="etund">

	
	<meta name="description" content="QQ音乐总结 前言 对于项目，有些细节以及小技巧是网上很难表达的，也很难找到，这需要经验的积累，如果有某些有经验的开发人员教你一些小技巧，经验心得，一定要总结，这样就可以少走很多弯路，所以很感谢小码哥的老师。
多媒体有别于我们一般的接触的项目，一切都值得记录。 小技巧 蒙版实现( &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="etund喔喔喔" type="application/atom+xml">
	
	<link rel="canonical" href="http://etund.github.com/blog/2015/08/22/qqyin-le-zong-jie/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			// $('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("a925813235z@qq.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
			$('.profilepic').append("<img src='/images/profine/profine.jpeg' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><!-- <ul class="main">
    <li><a href="/">主页 | Blog</a></li>
    <li><a href="/blog/archives">归档目录 | Archives</a></li>
    <li><a href="http://about.me/shashankmehta">关于我 | About</a></li>
    <li><a href="/intruduction">关于我 | About Me</a></li>
    <li><a href="/link">链接 | Links</a></li>
</ul> -->
<!-- <ul class="main">
    <li><a href="/">主页 | Blog</a></li>
    <li><a href="/blog/archives">归档目录 | Archives</a></li>
    <li><a href="http://about.me/shashankmehta">关于我 | About</a></li>
    <li><a href="/intruduction">关于我 | About Me</a></li>
    <li><a href="/link">链接 | Links</a></li>
</ul> -->
<html>
<!-- <head> -->
<!-- <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="/css/buttons.css" />
</head> -->
<!-- <body> -->
<div id="buttonContainer">
    <a href="/" class="button small gray rounded">主页 | Blog</a><br/><br/>
    <a href="/blog/archives" class="button small gray rounded">归档目录 | Archives</a><br/><br/>
    <a href="/intruduction" class="button small gray rounded">关于我 | About</a><br/><br/>
    <a href="/link" class="button small gray rounded">链接 | Links</a><br/><br/>
</div>
<!-- </body> -->
</html>
<style type="text/css">
.button{
    font:15px Calibri, Arial, sans-serif;

    /* A semi-transparent text shadow */
    text-shadow:1px 1px 0 rgba(255,255,255,0.4);
    
    /* Overriding the default underline styling of the links */
    text-decoration:none !important;
    white-space:nowrap;
    
    display:inline-block;
    vertical-align:baseline;
    position:relative;
    cursor:pointer;
    padding:10px 20px;
    
    background-repeat:no-repeat;

    /* The following two rules are fallbacks, in case
       the browser does not support multiple backgrounds. */

    background-position:bottom left;
    background-image:url('/images/button_bg.png');
    
    /* Multiple backgrounds version. The background images
       are defined individually in color classes */
    
    background-position:bottom left, top right, 0 0, 0 0;
    background-clip:border-box;
    
    /* Applying a default border raidus of 8px */
    
    -moz-border-radius:8px;
    -webkit-border-radius:8px;
    border-radius:8px;
    
    /* A 1px highlight inside of the button */
    
    -moz-box-shadow:0 0 1px #fff inset;
    -webkit-box-shadow:0 0 1px #fff inset;
    box-shadow:0 0 1px #fff inset;
    
    /* Animating the background positions with CSS3 */
    /* Currently works only in Safari/Chrome */
    
    -webkit-transition:background-position 1s;
    -moz-transition:background-position 1s;
    transition:background-position 1s;
}

.button:hover{
    
    /* The first rule is a fallback, in case the browser
       does not support multiple backgrounds
    */
    
    background-position:top left;
    background-position:top left, bottom right, 0 0, 0 0;
}

.button:active{
    /* Moving the button 1px to the bottom when clicked */
    bottom:-1px;
}

/* The three buttons sizes */

.button.big     { font-size:30px;}
.button.medium  { font-size:18px;}
.button.small   { font-size:13px;}

/* A more rounded button */

.button.rounded{
    -moz-border-radius:4em;
    -webkit-border-radius:4em;
    border-radius:4em;
}


/* Defining four button colors */


/* BlueButton */

.blue.button{
    color:#0f4b6d !important;
    
    border:1px solid #84acc3 !important;
    
    /* A fallback background color */
    background-color: #48b5f2;
    
    /* Specifying a version with gradients according to */
    
    background-image:   url('/images/button_bg.png'), url('/images/button_bg.png'),
                        -moz-radial-gradient(   center bottom, circle,
                                                rgba(89,208,244,1) 0,rgba(89,208,244,0) 100px),
                        -moz-linear-gradient(#4fbbf7, #3faeeb);

    background-image:   url('/images/button_bg.png'), url('/images/button_bg.png'),
                        -webkit-gradient(   radial, 50% 100%, 0, 50% 100%, 100,
                                            from(rgba(89,208,244,1)), to(rgba(89,208,244,0))),
                        -webkit-gradient(linear, 0% 0%, 0% 100%, from(#4fbbf7), to(#3faeeb));
}

.blue.button:hover{
    background-color:#63c7fe;
    
    background-image:   url('/images/button_bg.png'), url('/images/button_bg.png'),
                        -moz-radial-gradient(   center bottom, circle,
                                                rgba(109,217,250,1) 0,rgba(109,217,250,0) 100px),
                        -moz-linear-gradient(#63c7fe, #58bef7);
                        
    background-image:   url('/images/button_bg.png'), url('/images/button_bg.png'),
                        -webkit-gradient(   radial, 50% 100%, 0, 50% 100%, 100,
                                            from(rgba(109,217,250,1)), to(rgba(109,217,250,0))),
                        -webkit-gradient(linear, 0% 0%, 0% 100%, from(#63c7fe), to(#58bef7));
}

/* Green Button */

.green.button{
    color:#345903 !important;
    border:1px solid #96a37b !important;    
    background-color: #79be1e;
    
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -moz-radial-gradient(center bottom, circle, rgba(162,211,30,1) 0,rgba(162,211,30,0) 100px),-moz-linear-gradient(#82cc27, #74b317);
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -webkit-gradient(radial, 50% 100%, 0, 50% 100%, 100, from(rgba(162,211,30,1)), to(rgba(162,211,30,0))),-webkit-gradient(linear, 0% 0%, 0% 100%, from(#82cc27), to(#74b317));
}

.green.button:hover{
    background-color:#89d228;
    
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -moz-radial-gradient(center bottom, circle, rgba(183,229,45,1) 0,rgba(183,229,45,0) 100px),-moz-linear-gradient(#90de31, #7fc01e);
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -webkit-gradient(radial, 50% 100%, 0, 50% 100%, 100, from(rgba(183,229,45,1)), to(rgba(183,229,45,0))),-webkit-gradient(linear, 0% 0%, 0% 100%, from(#90de31), to(#7fc01e));
}

/* Orange Button */

.orange.button{
    color:#693e0a !important;
    border:1px solid #bea280 !important;    
    background-color: #e38d27;
    
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -moz-radial-gradient(center bottom, circle, rgba(232,189,45,1) 0,rgba(232,189,45,0) 100px),-moz-linear-gradient(#f1982f, #d4821f);
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -webkit-gradient(radial, 50% 100%, 0, 50% 100%, 100, from(rgba(232,189,45,1)), to(rgba(232,189,45,0))),-webkit-gradient(linear, 0% 0%, 0% 100%, from(#f1982f), to(#d4821f));
}

.orange.button:hover{
    background-color:#ec9732;
    
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -moz-radial-gradient(center bottom, circle, rgba(241,192,52,1) 0,rgba(241,192,52,0) 100px),-moz-linear-gradient(#f9a746, #e18f2b);
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -webkit-gradient(radial, 50% 100%, 0, 50% 100%, 100, from(rgba(241,192,52,1)), to(rgba(241,192,52,0))),-webkit-gradient(linear, 0% 0%, 0% 100%, from(#f9a746), to(#e18f2b));
}

.gray.button{
    color:#525252 !important;
    border:1px solid #a5a5a5 !important;    
    background-color: #a9adb1;
    
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -moz-radial-gradient(center bottom, circle, rgba(197,199,202,1) 0,rgba(197,199,202,0) 100px),-moz-linear-gradient(#c5c7ca, #92989c);
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -webkit-gradient(radial, 50% 100%, 0, 50% 100%, 100, from(rgba(197,199,202,1)), to(rgba(197,199,202,0))),-webkit-gradient(linear, 0% 0%, 0% 100%, from(#c5c7ca), to(#92989c));
}

.gray.button:hover{
    background-color:#b6bbc0;
    
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -moz-radial-gradient(center bottom, circle, rgba(202,205,208,1) 0,rgba(202,205,208,0) 100px),-moz-linear-gradient(#d1d3d6, #9fa5a9);
    background-image:url('/images/button_bg.png'), url('/images/button_bg.png'), -webkit-gradient(radial, 50% 100%, 0, 50% 100%, 100, from(rgba(202,205,208,1)), to(rgba(202,205,208,0))),-webkit-gradient(linear, 0% 0%, 0% 100%, from(#d1d3d6), to(#9fa5a9));
}

</style>

<section class="aboutme">
  <p>
    点滴记载,技术,设计,生活
  </p>
</section>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
			<a class="email" href="mailto:a925813235z@qq.com" title="Email">Email</a>
		
		
		
		
		
			<a class="github" href="https://github.com/etund" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">QQ音乐总结</h1>
	<div class="entry-content" itemprop="articleBody"><h4>前言</h4>

<ul>
<li>对于项目，有些细节以及小技巧是网上很难表达的，也很难找到，这需要经验的积累，如果有某些有经验的开发人员教你一些小技巧，经验心得，一定要总结，这样就可以少走很多弯路，所以很感谢<a href="http://www.520it.com/index.htm">小码哥</a>的老师。</li>
<li>多媒体有别于我们一般的接触的项目，一切都值得记录。</li>
</ul>


<!-- more -->


<h4>小技巧</h4>

<ul>
<li>蒙版实现(实现方式可以利用第三方框架，也可以用ToolBar实现，这里用ToolBar)</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="bp">UIToolbar</span> <span class="o">*</span><span class="n">toolBar</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UIToolbar</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">toolBar</span> <span class="nl">setBarStyle</span><span class="p">:</span><span class="n">UIBarStyleBlack</span><span class="p">];</span>
</span><span class='line'><span class="n">toolBar</span><span class="p">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">backgrounImgeView</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">toolBar</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">toolBar</span> <span class="nl">makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">make</span><span class="p">.</span><span class="n">edges</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">backgrounImgeView</span><span class="p">);</span>
</span><span class='line'><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>动画开始或暂停

<ul>
<li>两个CALayer的分类(可以把核心动画在不移除的情况下暂停或开始)</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">pauseAnimate</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="n">CFTimeInterval</span> <span class="n">pausedTime</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">convertTime</span><span class="p">:</span><span class="n">CACurrentMediaTime</span><span class="p">()</span> <span class="nl">fromLayer</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">timeOffset</span> <span class="o">=</span> <span class="n">pausedTime</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">resumeAnimate</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="n">CFTimeInterval</span> <span class="n">pausedTime</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">timeOffset</span><span class="p">];</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">timeOffset</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">beginTime</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'><span class="n">CFTimeInterval</span> <span class="n">timeSincePause</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">convertTime</span><span class="p">:</span><span class="n">CACurrentMediaTime</span><span class="p">()</span> <span class="nl">fromLayer</span><span class="p">:</span><span class="nb">nil</span><span class="p">]</span> <span class="o">-</span> <span class="n">pausedTime</span><span class="p">;</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">beginTime</span> <span class="o">=</span> <span class="n">timeSincePause</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>由于某些数据是在多个类都可以用到，所以，这里可以把一个工具类作为传输数据的桥梁，可以在一定程度上较少代码冗余。</li>
<li>歌词染色

<ul>
<li>在歌曲播放过程中，我们需要监听歌曲播放到哪里然后把一句歌词的部分高亮，如果之前没有接触过的话，直接想不到了。</li>
<li>这是我们可以自定义歌词label，然后再重写draw in rect的方法，根据传入的播放进度来染色，主要代码如下。</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setProgress:</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nv">progress</span><span class="p">{</span>
</span><span class='line'>    <span class="n">_progress</span> <span class="o">=</span> <span class="n">progress</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplay</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawRect:</span><span class="p">(</span><span class="bp">CGRect</span><span class="p">)</span><span class="nv">rect</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">super</span> <span class="nl">drawRect</span><span class="p">:</span><span class="n">rect</span><span class="p">];</span>
</span><span class='line'><span class="c1">//    获取需要画的区域</span>
</span><span class='line'>    <span class="bp">CGRect</span> <span class="n">fillRect</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="nb">self</span><span class="p">.</span><span class="n">progress</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
</span><span class='line'><span class="c1">//    设置颜色</span>
</span><span class='line'>    <span class="p">[[</span><span class="bp">UIColor</span> <span class="n">orangeColor</span><span class="p">]</span> <span class="n">set</span><span class="p">];</span>
</span><span class='line'><span class="c1">//    添加区域</span>
</span><span class='line'>    <span class="n">UIRectFillUsingBlendMode</span><span class="p">(</span><span class="n">fillRect</span><span class="p">,</span> <span class="n">kCGBlendModeSourceIn</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>UIRectFillUsingBlendMode这个方法第一个参数的填充的方式，而第二个参数是填充的颜色的方式，解释如下</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cm">/* Available in Mac OS X 10.5 &amp; later. R, S, and D are, respectively,</span>
</span><span class='line'><span class="cm">       premultiplied result, source, and destination colors with alpha; Ra,</span>
</span><span class='line'><span class="cm">       Sa, and Da are the alpha components of these colors.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">       The Porter-Duff &quot;source over&quot; mode is called `kCGBlendModeNormal&#39;:</span>
</span><span class='line'><span class="cm">         R = S + D*(1 - Sa)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">       Note that the Porter-Duff &quot;XOR&quot; mode is only titularly related to the</span>
</span><span class='line'><span class="cm">       classical bitmap XOR operation (which is unsupported by</span>
</span><span class='line'><span class="cm">       CoreGraphics). */</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kCGBlendModeClear</span><span class="p">,</span>          <span class="cm">/* R = 0 */</span>
</span><span class='line'>    <span class="n">kCGBlendModeCopy</span><span class="p">,</span>           <span class="cm">/* R = S */</span>
</span><span class='line'>    <span class="n">kCGBlendModeSourceIn</span><span class="p">,</span>       <span class="cm">/* R = S*Da */</span>
</span><span class='line'>    <span class="n">kCGBlendModeSourceOut</span><span class="p">,</span>      <span class="cm">/* R = S*(1 - Da) */</span>
</span><span class='line'>    <span class="n">kCGBlendModeSourceAtop</span><span class="p">,</span>     <span class="cm">/* R = S*Da + D*(1 - Sa) */</span>
</span><span class='line'>    <span class="n">kCGBlendModeDestinationOver</span><span class="p">,</span>    <span class="cm">/* R = S*(1 - Da) + D */</span>
</span><span class='line'>    <span class="n">kCGBlendModeDestinationIn</span><span class="p">,</span>      <span class="cm">/* R = D*Sa */</span>
</span><span class='line'>    <span class="n">kCGBlendModeDestinationOut</span><span class="p">,</span>     <span class="cm">/* R = D*(1 - Sa) */</span>
</span><span class='line'>    <span class="n">kCGBlendModeDestinationAtop</span><span class="p">,</span>    <span class="cm">/* R = S*(1 - Da) + D*Sa */</span>
</span><span class='line'>    <span class="n">kCGBlendModeXOR</span><span class="p">,</span>            <span class="cm">/* R = S*(1 - Da) + D*(1 - Sa) */</span>
</span><span class='line'>    <span class="n">kCGBlendModePlusDarker</span><span class="p">,</span>     <span class="cm">/* R = MAX(0, (1 - D) + (1 - S)) */</span>
</span><span class='line'>    <span class="n">kCGBlendModePlusLighter</span>        <span class="cm">/* R = MIN(1, S + D) */</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>上面解释大概的意思就是：R表示计算结果，S：表示包含alpha的源颜色,D表示包含alpha的目标颜色，Sa  Da 分别是对应颜色的alpha值，每个枚举后面是计算的公式，先简单记一下吧，以后在深入研究。</li>
</ul>


<h4>开始播放</h4>

<p><code>我的主要思路如下</code></p>

<ul>
<li>界面更新

<ul>
<li>时间的变化时时更新</li>
<li>歌曲名字,歌手名字，图片，只更新一遍</li>
</ul>
</li>
<li>滑条的变化

<ul>
<li>如何让滑条的变化来控制歌曲的播放进度？

<ul>
<li>获取滑条的变化。</li>
<li>控制歌曲的进度。</li>
</ul>
</li>
</ul>
</li>
<li>监听歌词的变化

<ul>
<li>UIScrollVie约束实现原则

<ul>
<li>scrollView必须有宽高和位置(也就是四重奏)</li>
<li>然后按照正常人的四维约束scrollView的子控件，但是子控件必须包含宽高</li>
</ul>
</li>
</ul>
</li>
</ul>


<h4>遇到问题</h4>

<ul>
<li>AVAudioPlayer的底层实现会内存泄露</li>
<li>为什么调用prepareToPlay出现断点？(在添加全局断点的时候就会出现断点)

<pre><code>  - 现在分析一下代码如下
</code></pre></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="bp">AVAudioPlayer</span> <span class="o">*</span><span class="n">player</span>  <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>  <span class="n">player</span> <span class="o">=</span> <span class="n">_players</span><span class="p">[</span><span class="n">musicName</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">player</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="bp">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="nl">URLForResource</span><span class="p">:</span><span class="n">musicName</span> <span class="nl">withExtension</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="n">player</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">AVAudioPlayer</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithContentsOfURL</span><span class="p">:</span><span class="n">url</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_players</span> <span class="nl">setObject</span><span class="p">:</span><span class="n">player</span> <span class="nl">forKey</span><span class="p">:</span><span class="n">musicName</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">player</span> <span class="n">prepareToPlay</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">[</span><span class="n">player</span> <span class="n">play</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>现在情况是player不为空且正确，但是调用prepareToPlay方法的时候就会停留在这里并且停5次，但是<code>if (player == nil)</code>外面只执行一次，但是为什么会这样呢？那只能说明这个方法有问题了，于是我把全局断点只监听OC代码块的，像这样。</p>

<p>  <img src="/images/blog/qqyinyuebofangqi/Snip20150821_3.png" alt="" />
  <img src="/images/blog/qqyinyuebofangqi/Snip20150821_4.png" alt="" />
  <img src="/images/blog/qqyinyuebofangqi/Snip20150821_6.png" alt="" /></p></li>
<li><p>这样问题就解决了，于是乎，我又试着监听C++代码块的，果然问题又出现了，啊，C++这东西在苹果对于我们基本上是不可见了，但它底层实现有问题啊，额&hellip;，这样的话，我们就要试着寻求新的播放框架了.<code>值得一提的是后面调用这个实例的stop方法也会出现类似情况</code></p></li>
<li>之后用instruments内存分析，发现的确存在内存泄露，内存泄露的问题出在底层内部，不懂，如下图
  <img src="/images/blog/qqyinyuebofangqi/Snip20150821_2.png" alt="" /></li>
</ul>


<h4>音乐控制歌词</h4>

<ul>
<li><p>歌词解析</p>

<ul>
<li>从文件里面加载数据</li>
<li>把数据分割为一行一行作为一个对象</li>
<li>把一行一行分割成属性</li>
<li>获取当前的时间</li>
<li>对比模型的时间，如果大于当前时间小于下一个时间，或者下一行为空，显示当前行，刷新当前行和上一上，滚到对应的歌词</li>
<li>对比歌词</li>
</ul>
</li>
<li><p>歌词美化</p>

<ul>
<li>获取单行的播放进度</li>
<li>上色，放大

<ul>
<li>当我们给歌词上色的时候，会出现重用cell的时候，cell重复的没有褪色？

<ul>
<li>tableView的数据源方法返回cell的时候，判断cell的是否是当前要显示的行，来让cell退色。</li>
</ul>
</li>
<li>但是这里歌词会卡顿，那是因为定时器的设的时间跟监听歌播放时间的定时器一样是一秒，太长了，所以这里要单独给歌词添加一个定时器。</li>
</ul>
</li>
</ul>
</li>
</ul>


<h4>锁屏显示</h4>

<ul>
<li>数据获取

<ul>
<li> (歌词)获取icon，获取前一句歌词，下一句歌词，当前歌词，然后画图，</li>
</ul>
</li>
<li>显示歌名，背景图

<ul>
<li>在设置界面的Capabilities里面开启后台模式，并且选择后台播放音频
<img src="/images/blog/qqyinyuebofangqi/Snip20150821_5.png" alt="" /></li>
<li>在代理(AppDelegate)里面添加激活会话</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// Override point for customization after application launch.</span>
</span><span class='line'><span class="c1">//    获取音频回话</span>
</span><span class='line'>    <span class="bp">AVAudioSession</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="p">[</span><span class="bp">AVAudioSession</span> <span class="n">sharedInstance</span><span class="p">];</span>
</span><span class='line'><span class="c1">//    设置后台播放类别</span>
</span><span class='line'>    <span class="p">[</span><span class="n">session</span> <span class="nl">setCategory</span><span class="p">:</span><span class="n">AVAudioSessionCategoryPlayback</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="c1">//    激活会话</span>
</span><span class='line'>    <span class="p">[</span><span class="n">session</span> <span class="nl">setActive</span><span class="p">:</span><span class="nb">YES</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h4>其他</h4>

<ul>
<li><p>傻傻分不清stringWithContentsOfFile:usedEncoding:error: 与 stringWithContentsOfFile:encoding:error:</p>

<ul>
<li>stringWithContentsOfFile:usedEncoding:error:这个方法是智能判断一段字符串使用什么编码，而usedEncoding是要我们存进一个内存地址，用于存放它的真实编码方式，我们可以通过后续打印这个参数来看看它真实的编码方式</li>
<li>stringWithContentsOfFile:encoding:error:这个方法是我们已经知道了这个编码方式，要他必须按照我们的编码方式来解码。</li>
</ul>
</li>
<li><p>componentsSeparatedByString:这个方法用于切割歌词按照一个分割来分割字符串并返回分割后的字符串的数组。</p></li>
</ul>

</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	
    <style>
    .flash-video{display:none;}
</style>
<!-- JiaThis Button BEGIN -->
<div id="ckepop">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_t163">网易微博</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_renren">人人网</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=1574434" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
    data_track_clickback:true,
    sm:"t163,tsina,tqq,renren,douban",
    summary:"",
    hideMore:false
}
</script>
<script type="text/javascript" src="http://v2.jiathis.com/code_mini/jia.js?uid=1574434" charset="utf-8"></script>
<!-- JiaThis Button END -->

<!-- <br /> -->
<!-- UY BEGIN -->
<!-- <div id="uyan_frame"></div>
<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=89581" async=""></script>
 --><!-- UY END -->
  	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>




  <section>
    <h1>Comments</h1>
    <div id="comments" aria-live="polite"><!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-title="QQ音乐总结"></div>
<script type="text/javascript">
  var duoshuoQuery = {short_name:"etund"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END --></div>
  </section>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2015

    etund


<!-- Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a> --></footer>
		</div>
	</div>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>
